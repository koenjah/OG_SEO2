<div class="app-hero">
  <div class="hero-content">
    <h1>SEO rapportage</h1>
    <p>Snel inzicht in je website prestaties</p>
  </div>
</div>

<div class="app-input-container">
  <form action="/generate-report" method="POST">
    <input type="hidden" name="visitorId" id="visitorId">
    <div class="app-input-wrapper">
      <div class="input-icon">
        <i class="bi bi-globe"></i>
      </div>
      <input 
        type="text" 
        class="app-input" 
        id="domain" 
        name="domain" 
        placeholder="Voer je website in..." 
        required
        autocomplete="off"
        value="{{prefill.url}}"
      >
      <button type="submit" class="app-submit">
        <i class="bi bi-arrow-right"></i>
      </button>
    </div>
    <small class="input-hint">Bijvoorbeeld: jouwwebsite.nl</small>
  </form>
</div>

<div class="app-features-grid">
  <div class="feature-item">
    <i class="bi bi-graph-up"></i>
    <span>Bezoekers</span>
  </div>
  <div class="feature-item">
    <i class="bi bi-search"></i>
    <span>Zoekwoorden</span>
  </div>
  <div class="feature-item">
    <i class="bi bi-shield-check"></i>
    <span>Autoriteit</span>
  </div>
  <div class="feature-item">
    <i class="bi bi-speedometer"></i>
    <span>Snelheid</span>
  </div>
</div>

{{#if rateLimitMsg}}
  <!-- Rate limit reached modal -->
  <div class="modal fade premium-modal" id="rateLimitModal" tabindex="-1" aria-labelledby="rateLimitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content premium-modal-content">
        <div class="modal-header premium-modal-header">
          <div class="premium-header-content">
            <h5 class="modal-title premium-modal-title" id="rateLimitModalLabel">Limiet bereikt</h5>
            <div class="premium-modal-subtitle">Optimaal Groeien SEO Tool</div>
          </div>
          <button type="button" class="btn-close premium-close-button" data-bs-dismiss="modal" aria-label="Sluiten"></button>
        </div>
        <div class="modal-body premium-modal-body">
          <div class="rate-limit-content">
            <div class="rate-limit-profile">
              <div class="rate-limit-img-container">
                <img src="/img/stefan.webp" alt="Stefan Kelderman" class="rate-limit-img img-fluid">
              </div>
              <div class="rate-limit-name">
                <div class="profile-name">Stefan Kelderman</div>
                <div class="profile-title">Eigenaar Optimaal Groeien</div>
              </div>
            </div>
            <div class="rate-limit-text premium-text">
              {{#if rateLimitMsg}}
                {{{rateLimitMsg}}}
              {{/if}}
            </div>
          </div>
        </div>
        <div class="modal-footer premium-modal-footer">
          <a href="https://calendly.com/optimaalgroeien/kennismaking" target="_blank" class="btn premium-button">Plan een gesprek <i class="fas fa-arrow-right ms-2"></i></a>
        </div>
      </div>
    </div>
  </div>


<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
{{! Laad EERST de loading-animation.js, dan pas dit script }}
{{! Zorg dat het pad klopt - het staat in public/js }}
<script src="/js/loading-animation.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const initializeAndCheckDomain = async () => {
      try {
        // 1. Haal Fingerprint ID op en zet het in de hidden input
        let visitorId = '';
        const visitorIdInput = document.getElementById('visitorId');
        if (typeof FingerprintJS !== 'undefined') {
            const fp = await FingerprintJS.load();
            const result = await fp.get();
            visitorId = result.visitorId;
            if (visitorIdInput) {
                visitorIdInput.value = visitorId;
                // console.log("Fingerprint Visitor ID:", visitorId);
            } else {
                console.warn("Hidden input #visitorId niet gevonden!");
            }
        } else {
            console.error("FingerprintJS library niet geladen!");
        }

        // 2. Lees de 'domain' parameter uit de browser URL
        const urlParams = new URLSearchParams(window.location.search);
        const domainFromQuery = urlParams.get('domain');
        // console.log("Domain parameter uit iframe URL:", domainFromQuery);

        if (domainFromQuery) {
            const domainInput = document.getElementById('domain');
            const reportForm = document.querySelector('form[action="/generate-report"]');

            if (domainInput && reportForm) {
                const decodedDomain = decodeURIComponent(domainFromQuery);
                domainInput.value = decodedDomain; // Vul de zichtbare input in

                // Controleer of visitorId correct is ingesteld
                if (visitorIdInput && visitorIdInput.value === visitorId) {

                    // ----- NIEUW: Start de animatie handmatig -----
                    if (typeof LoadingAnimation !== 'undefined') {
                        // console.log("Animatie handmatig starten voor:", decodedDomain);
                        const loadingAnimation = new LoadingAnimation();
                        // Gebruik de domeinnaam ZONDER http/www voor de animatie tekst
                        const displayDomain = decodedDomain.replace(/^(https?:\/\/)?(www\.)?/i, '');
                        loadingAnimation.init(displayDomain);
                    } else {
                        console.error("LoadingAnimation class is niet beschikbaar!");
                    }
                    // ----- EINDE NIEUW -----

                    // Wacht heel even NA het starten van de animatie
                    // (geeft de animatie tijd om te renderen/starten)
                    setTimeout(() => {
                        // console.log(`Formulier wordt nu gesubmit voor ${decodedDomain} met visitor ID ${visitorId}`);
                        reportForm.submit();
                    }, 300); // Iets langere delay nu de animatie start

                } else {
                    console.error("Visitor ID kon niet correct worden ingesteld vóór submit. Formulier niet automatisch verzonden.");
                }
            } else {
                console.error("Kon domein input (#domain) of formulier (action='/generate-report') niet vinden.");
            }
        } else {
            // console.log("Geen 'domain' parameter gevonden, formulier wordt niet automatisch gesubmit.");
            const serverPrefill = '{{prefill.url}}';
            if (serverPrefill && domainInput) {
                 domainInput.value = serverPrefill;
                 // console.log("Domein ingevuld via server prefill:", serverPrefill);
            }
        }
      } catch (error) {
        console.error("Fout tijdens initialisatie script:", error);
      }
    };

    initializeAndCheckDomain();
  });
</script>
